<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canada CPI Index Chart - 10 Years</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin-top: 0;
            color: #333;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            overflow: visible;
        }
        
        #chart {
            display: block;
            margin: 0 auto;
        }
        
        .axis {
            font-size: 12px;
            color: #666;
        }
        
        .axis-label {
            font-size: 14px;
            fill: #333;
        }
        
        .line {
            fill: none;
            stroke: #1f77b4;
            stroke-width: 2.5px;
        }
        
        .area {
            fill: #1f77b4;
            opacity: 0.1;
        }
        
        .grid-line {
            stroke: #e0e0e0;
            stroke-width: 1;
            stroke-dasharray: 3,3;
        }
        
        .baseline {
            stroke: #999;
            stroke-width: 1.5;
            stroke-dasharray: 5,5;
        }
        
        .dot {
            fill: #1f77b4;
            stroke: white;
            stroke-width: 2;
            r: 4;
        }
        
        .dot:hover {
            r: 6;
            cursor: pointer;
        }
        
        .focus-line {
            stroke: #333;
            stroke-width: 1.5;
            stroke-dasharray: 3,3;
            opacity: 0;
            pointer-events: none;
        }
        
        .focus-line.visible {
            opacity: 1;
        }
        
        .focus-dot {
            fill: #1f77b4;
            stroke: white;
            stroke-width: 3;
            r: 6;
            opacity: 0;
            pointer-events: none;
        }
        
        .focus-dot.visible {
            opacity: 1;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            min-width: 180px;
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        .tooltip strong {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 4px;
        }
        
        .tooltip .value-row {
            margin: 4px 0;
        }
        
        .tooltip .change {
            color: #a0d8ff;
            font-size: 11px;
        }
        
        .legend {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Canada Consumer Price Index (CPI) - Multi-Series</h1>
        <div class="subtitle">10 Years of Monthly Data - 6 Main Categories</div>
        <div class="chart-container">
            <div class="loading">Loading data...</div>
            <svg id="chart"></svg>
        </div>
        <div class="legend">
            <p><strong>Note:</strong> Hover over the chart to dynamically re-index all series. Each series shows relative changes compared to the hovered date (baseline = 1×).</p>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // Load data
        d3.json("data/inflation_multi_series.json")
            .then(data => {
                document.querySelector(".loading").style.display = "none";
                
                // Parse dates and prepare data - convert to Date objects and extract values
                // Use UTC parsing to match scaleUtc
                const parseDate = d3.utcParse("%Y-%m");
                
                // Transform data structure to match Observable pattern
                // Each series has: {key: "Category", values: [{Date, value}]}
                const series = data.series.map(({category, data: seriesData}) => ({
                    key: category,
                    values: seriesData.map(d => ({
                        Date: parseDate(d.date),
                        value: d.value
                    })).filter(d => d.Date !== null) // Filter out any invalid dates
                }));
                
                // Normalize the series with respect to the value on the first date
                const normalizedSeries = series.map(({key, values}) => {
                    const v = values[0].value;
                    return {key, values: values.map(({Date, value}) => ({Date, value: value / v}))};
                });
                
                // Get all dates from all series for domain calculation
                const allDates = normalizedSeries.flatMap(s => s.values.map(d => d.Date));
                
                // Specify the chart's dimensions.
                const width = 928;
                const height = 600;
                const marginTop = 20;
                const marginRight = 120;  // Increased to accommodate labels
                const marginBottom = 30;
                const marginLeft = 40;
                
                // Create the horizontal time scale.
                const x = d3.scaleUtc()
                    .domain(d3.extent(allDates))
                    .range([marginLeft, width - marginRight])
                    .clamp(true);
                
                // Create the vertical scale. For each series, compute the ratio *s* between its maximum and
                // minimum values; the path is going to move between [1 / s, 1] when the reference date
                // corresponds to its maximum and [1, s] when it corresponds to its minimum. To have enough
                // room, the scale is based on the series that has the maximum ratio *k*.
                const k = d3.max(normalizedSeries, ({values}) => d3.max(values, d => d.value) / d3.min(values, d => d.value));
                const y = d3.scaleLog()
                    .domain([1 / k, k])
                    .rangeRound([height - marginBottom, marginTop]);
                
                // Create a color scale to identify series.
                // Use a custom color scheme for better distinction
                const colors = {
                    "Overall": "#1f77b4",    // Blue
                    "Food": "#ff7f0e",        // Orange
                    "Housing": "#2ca02c",     // Green
                    "Transport": "#d62728",   // Red
                    "Health Care": "#9467bd", // Purple
                    "Services": "#8c564b"     // Brown
                };
                const z = (key) => colors[key] || "#000000";
                
                // For each given series, the update function needs to identify the date—closest to the current
                // date—that actually contains a value. To do this efficiently, it uses a bisector:
                const bisect = d3.bisector(d => d.Date).left;
                
                // Create the SVG container.
                // Add extra width for labels (labels are positioned at width - marginRight + 3, need ~80px for text)
                const svgWidth = width + 80;  // Extra space for labels
                const svg = d3.select("#chart")
                    .attr("width", svgWidth)
                    .attr("height", height)
                    .attr("viewBox", [0, 0, svgWidth, height])
                    .attr("style", "max-width: 100%; height: auto; -webkit-tap-highlight-color: transparent;");
                
                // Create the axes and central rule.
                svg.append("g")
                    .attr("transform", `translate(0,${height - marginBottom})`)
                    .call(d3.axisBottom(x).ticks(width / 80).tickSizeOuter(0))
                    .call(g => g.select(".domain").remove());
                
                svg.append("g")
                    .attr("transform", `translate(${marginLeft},0)`)
                    .call(d3.axisLeft(y)
                        .ticks(null, x => +x.toFixed(6) + "×"))
                    .call(g => g.selectAll(".tick line").clone()
                        .attr("stroke-opacity", d => d === 1 ? null : 0.2)
                        .attr("x2", width - marginLeft - marginRight))
                    .call(g => g.select(".domain").remove());
                
                const rule = svg.append("g")
                    .append("line")
                    .attr("y1", height)
                    .attr("y2", 0)
                    .attr("stroke", "black");
                
                // Create a line and a label for each series.
                const serie = svg.append("g")
                    .style("font", "bold 10px sans-serif")
                    .selectAll("g")
                    .data(normalizedSeries)
                    .join("g");
                
                const line = d3.line()
                    .x(d => x(d.Date))
                    .y(d => y(d.value));
                
                serie.append("path")
                    .attr("fill", "none")
                    .attr("stroke-width", 2)
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("stroke", d => z(d.key))
                    .attr("d", d => line(d.values));
                
                serie.append("text")
                    .datum(d => ({key: d.key, value: d.values[d.values.length - 1].value}))
                    .attr("fill", d => z(d.key))
                    .attr("paint-order", "stroke")
                    .attr("stroke", "white")
                    .attr("stroke-width", 3)
                    .attr("x", x.range()[1] + 3)
                    .attr("y", d => y(d.value))
                    .attr("dy", "0.35em")
                    .style("font-size", "11px")
                    .text(d => d.key);
                
                // Define the update function, that translates each of the series vertically depending on the
                // ratio between its value at the current date and the value at date 0. Thanks to the log
                // scale, this gives the same result as a normalization by the value at the current date.
                function update(date) {
                    // Round to nearest month (since we have monthly data)
                    date = d3.utcMonth.round(date);
                    rule.attr("transform", `translate(${x(date) + 0.5},0)`);
                    serie.attr("transform", ({values}) => {
                        const i = bisect(values, date, 0, values.length - 1);
                        // Clamp i to valid range
                        const idx = Math.max(0, Math.min(i, values.length - 1));
                        return `translate(0,${y(1) - y(values[idx].value / values[0].value)})`;
                    });
                    svg.property("value", date).dispatch("input"); // for viewof compatibility
                }
                
                // Create the introductory animation. It repeatedly calls the update function for dates ranging
                // from the last to the first date of the x scale.
                d3.transition()
                    .ease(d3.easeCubicOut)
                    .duration(1500)
                    .tween("date", () => {
                        const i = d3.interpolateDate(x.domain()[1], x.domain()[0]);
                        return t => update(i(t));
                    });
                
                // When the user mouses over the chart, update it according to the date that is
                // referenced by the horizontal position of the pointer.
                svg.on("mousemove touchmove", function(event) {
                    update(x.invert(d3.pointer(event, this)[0]));
                    if (event.preventDefault) event.preventDefault();
                });
                
                // Sets the date to the start of the x axis. This is redundant with the transition above;
                // uncomment if you want to remove the transition.
                // update(x.domain()[0]);
            })
            .catch(error => {
                console.error("Error loading data:", error);
                document.querySelector(".loading").textContent = "Error loading data. Please check that inflation_multi_series.json exists.";
            });
    </script>
</body>
</html>

